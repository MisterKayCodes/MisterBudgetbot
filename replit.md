# Mister Budget - Telegram Bot

## Overview

Mister Budget is a comprehensive Telegram bot built with aiogram v3 that helps users manage their personal finances. The bot enables users to track income and expenses, set savings goals, manage multiple accounts, receive financial insights, and optionally subscribe for premium features. It uses SQLite for data persistence and implements a feature-based modular architecture.

## User Preferences

Preferred communication style: Simple, everyday language.

## System Architecture

### Technology Stack
- **Framework**: aiogram 3.4.1 (asynchronous Telegram bot framework)
- **Database**: SQLite via aiosqlite (async SQLite adapter)
- **Task Scheduling**: APScheduler 3.10.4 (for reminder/notification scheduling)
- **Data Processing**: pandas 2.1.4 (for CSV export generation)
- **Configuration**: python-dotenv 1.0.0 (environment variable management)

### Architectural Pattern
The application follows a **feature-based modular architecture** where each major feature is isolated in its own module with consistent internal structure:

```
features/
  ├── feature_name/
  │   ├── handlers/      # Telegram message/callback handlers
  │   ├── services/      # Business logic layer
  │   ├── keyboards/     # Inline keyboard definitions
  │   ├── states/        # FSM (Finite State Machine) states
  │   └── validators/    # Input validation functions
```

This promotes separation of concerns, maintainability, and scalability.

### Core Features

**Financial Management**
- Multi-account system (Main, Spending, Savings, Business accounts)
- Automatic income splitting based on user-defined percentages
- Expense tracking with category classification
- Savings goals with auto-save percentages and deadline tracking
- Transaction history with filtering capabilities

**Analytics & Insights**
- Financial advisor with spending/savings analysis
- Category-wise expense breakdown
- Smart recommendations based on spending habits
- Period-based summaries (weekly, monthly, all-time)
- CSV export functionality for transaction data

**User Experience**
- FSM-based conversational flows for data entry
- Inline keyboard navigation throughout the application
- Customizable settings (currency, income split percentages)
- Reminder system with toggleable daily/weekly notifications

**Subscription System**
- Optional subscription mode (admin-controlled toggle)
- Trial code redemption mechanism
- Subscription status tracking with expiration dates
- Admin-only users and active subscribers bypass subscription requirements

### Database Schema

The application uses SQLite with the following core tables:

**users**: User profiles with currency preferences and income split percentages
**accounts**: Multiple account types per user with individual balances
**transactions**: Income/expense records with categories and timestamps
**goals**: Savings goals with target amounts, deadlines, and auto-save settings
**reminders**: User notification preferences (daily/weekly toggles)
**subscriptions**: Subscription plans with start/end dates and status tracking
**trial_codes**: Redeemable trial codes generated by admins
**admin_settings**: Global settings including subscription mode toggle

All tables use `created_at` and `updated_at` timestamps for audit trails.

### State Management

The bot uses aiogram's FSM (Finite State Machine) with MemoryStorage for managing conversational flows. Each feature defines its own state groups:
- OnboardingStates (name, email collection)
- IncomeStates (amount input)
- ExpenseStates (name, amount, category selection)
- GoalsStates (goal creation flow)
- SettingsStates (split percentage configuration)
- SubscriptionStates (trial code redemption)
- AdminStates (admin operations)

### Access Control

**Role-Based Access**
- Admin users (defined in ADMIN_IDS environment variable) have unrestricted access
- Regular users require active subscriptions when subscription mode is enabled
- Subscription mode can be toggled globally by admins

**Subscription Enforcement**
When subscription mode is active, non-admin users without valid subscriptions see only the subscription menu. Active subscribers and admins see the full feature set.

### Data Flow Architecture

**Income Processing**
1. User inputs amount
2. System splits based on user percentages (default: 60% Spending, 20% Savings, 20% Business)
3. Balances updated across respective accounts
4. Transaction recorded
5. Auto-save goals receive allocated percentages from the income

**Expense Processing**
1. User provides description, amount, and category
2. System validates sufficient balance in Spending account
3. Balance deducted from Spending account
4. Transaction recorded with category metadata

**Goal Tracking**
1. Users create goals with target amounts and optional deadlines
2. Auto-save percentage allocates portion of each income automatically
3. Progress tracked with visual progress bars
4. Goals marked complete when target reached

### Error Handling & Validation

- Input validators ensure data integrity (amounts, emails, percentages)
- Database operations wrapped in try-catch patterns
- User feedback provided for invalid inputs
- State management allows recovery from errors without losing context

### Extensibility Points

The architecture supports easy extension:
- New features added as isolated modules following the established pattern
- Database migrations handled via dedicated migration scripts
- Scheduler integration ready for automated tasks (reminders, reports)
- Payment integration stub exists (currently manual admin approval)